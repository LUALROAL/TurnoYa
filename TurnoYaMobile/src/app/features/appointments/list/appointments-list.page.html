<ion-header class="ion-no-border">
  <div class="t-page-header t-pt-6 t-px-4">
    <div class="t-flex-row t-justify-between t-items-center">
      <ion-buttons>
        <ion-back-button defaultHref="/home" color="dark"></ion-back-button>
      </ion-buttons>
      <h1 class="t-h2">Mis Citas</h1>
      <div style="width: 32px"></div> <!-- Spacer for alignment -->
    </div>

    <!-- Custom Segment Control -->
    <div class="segment-container t-mt-4">
      <div class="segment-wrapper">
        <button class="segment-btn" [class.active]="status === 'Upcoming'" (click)="onStatusChange('Upcoming')">
          Pr√≥ximas
        </button>
        <button class="segment-btn" [class.active]="status === 'Completed'" (click)="onStatusChange('Completed')">
          Historial
        </button>
        <button class="segment-btn" [class.active]="status === 'Cancelled'" (click)="onStatusChange('Cancelled')">
          Canceladas
        </button>
      </div>
    </div>
  </div>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content pullingIcon="chevron-down" refreshingSpinner="crescent"></ion-refresher-content>
  </ion-refresher>

  <div class="t-page">

    <!-- Empty State -->
    @if (!isLoading && appointments.length === 0) {
    <div class="t-flex-col t-items-center t-justify-center t-h-full t-py-12 empty-container">
      <div class="icon-circle">
        <ion-icon name="calendar-number-outline"></ion-icon>
      </div>
      <h3 class="t-h3 t-mt-4 text-center">Sin citas {{ status === 'Upcoming' ? 'pendientes' : 'en esta lista' }}</h3>
      <p class="t-body t-text-secondary text-center">No hay reservas para mostrar por ahora.</p>

      @if (status === 'Upcoming') {
      <ion-button expand="block" shape="round" class="t-mt-8" routerLink="/business/list">
        Explorar Negocios
      </ion-button>
      }
    </div>
    }

    <!-- Loading Skeleton -->
    @if (isLoading) {
    <div class="t-grid">
      @for (i of [1,2,3]; track i) {
      <div class="t-card appointment-card skeleton">
        <div class="t-flex-row t-justify-between">
          <ion-skeleton-text animated style="width: 40%"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 20%"></ion-skeleton-text>
        </div>
        <ion-skeleton-text animated style="width: 70%; margin-top: 10px"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 30%; margin-top: 5px"></ion-skeleton-text>
      </div>
      }
    </div>
    }

    <!-- Appointments List -->
    @if (!isLoading && appointments.length > 0) {
    <div class="t-grid">
      @for (appt of appointments; track appt.id) {
      <div class="t-card appointment-card ripple-parent" (click)="viewDetail(appt.id)">

        <!-- Date Badge (Left) -->
        <div class="date-column">
          <span class="day">{{ appt.startDate | date:'dd' }}</span>
          <span class="month">{{ appt.startDate | date:'MMM' }}</span>
        </div>

        <!-- Content -->
        <div class="info-content">
          <div class="t-flex-row t-justify-between t-items-start">
            <h3 class="t-h4 text-primary">{{ appt.service?.name || 'Servicio' }}</h3>
            <span class="time-badge">{{ appt.startDate | date:'HH:mm' }}</span>
          </div>

          <p class="business-name t-body t-text-secondary t-mt-1">
            <ion-icon name="storefront-outline" style="vertical-align: text-bottom; margin-right: 4px;"></ion-icon>
            {{ appt.business?.name || 'Negocio' }}
          </p>

          <div class="t-flex-row t-justify-between t-items-end t-mt-3">
            <span class="status-badge" [ngClass]="appt.status.toLowerCase()">
              {{ getStatusLabel(appt.status) }}
            </span>
            <span class="price t-h4">${{ appt.service?.price }}</span>
          </div>
        </div>

      </div>
      }
    </div>
    }

  </div>
</ion-content>
