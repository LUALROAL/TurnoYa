<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Negocios</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-searchbar
      [(ngModel)]="searchTerm"
      (ionInput)="onSearch($event)"
      placeholder="Buscar negocios..."
      debounce="500">
    </ion-searchbar>
  </ion-toolbar>

  <!-- Filtro de categorías -->
  <ion-toolbar>
    <div class="filter-container">
      @if (selectedCategory) {
        <ion-chip color="primary" (click)="clearCategory()">
          <ion-label>{{ selectedCategory }}</ion-label>
          <ion-icon name="close-circle"></ion-icon>
        </ion-chip>
      }
      <ion-select
        [(ngModel)]="selectedCategory"
        (ionChange)="onCategoryChange($event)"
        placeholder="Filtrar por categoría"
        interface="popover">
        <ion-select-option value="">Todas las categorías</ion-select-option>
        @for (category of availableCategories; track category) {
          <ion-select-option [value]="category">{{ category }}</ion-select-option>
        }
      </ion-select>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="business-container ion-padding">
    <!-- Loading inicial -->
    @if (isLoading && businesses.length === 0) {
      <div class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando negocios...</p>
      </div>
    }

    <!-- Lista de negocios -->
    @if (!isLoading || businesses.length > 0) {
      <ion-list [inset]="true">
        @for (business of businesses; track business.id) {
          <ion-card (click)="viewBusinessDetail(business.id)">
            <ion-card-header>
              <ion-card-title>{{ business.name }}</ion-card-title>
              @if (business.category) {
                <ion-card-subtitle>
                  <ion-icon name="pricetag-outline"></ion-icon>
                  {{ business.category }}
                </ion-card-subtitle>
              }
            </ion-card-header>

            <ion-card-content>
              @if (business.description) {
                <p>{{ business.description }}</p>
              }

              <div class="business-info">
                @if (business.address) {
                  <div class="info-item">
                    <ion-icon name="location-outline"></ion-icon>
                    <span>{{ business.address }}, {{ business.city }}</span>
                  </div>
                }
                @if (business.phone) {
                  <div class="info-item">
                    <ion-icon name="call-outline"></ion-icon>
                    <span>{{ business.phone }}</span>
                  </div>
                }
              </div>

              <ion-button expand="block" fill="outline" size="small" class="ion-margin-top">
                Ver detalles
              </ion-button>
            </ion-card-content>
          </ion-card>
        }
      </ion-list>
    }

    <!-- Mensaje sin resultados -->
    @if (!isLoading && businesses.length === 0) {
      <div class="empty-state ion-text-center">
        <ion-icon name="business-outline" size="large"></ion-icon>
        <h3>No se encontraron negocios</h3>
        <p>Intenta con otros términos de búsqueda</p>
      </div>
    }

    <!-- Infinite scroll -->
    <ion-infinite-scroll (ionInfinite)="onLoadMore($event)" [disabled]="!hasMore">
      <ion-infinite-scroll-content loadingSpinner="crescent">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </div>

  <!-- FAB para crear negocio -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="createBusiness()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
